<!DOCTYPE html>
<html>
  <head>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-61305800-1', 'auto');
      ga('send', 'pageview');

    </script>
    <meta charset="utf-8" />
      <title>Mach-O Binaries</title>
      <style>.markdown-preview { font-family: 'Helvetica Neue', Helvetica, sans-serif; font-size: 14px; line-height: 1.6; overflow: scroll; box-sizing: border-box; padding: 20px; background-color: rgb(255, 255, 255); }
.markdown-preview code { color: rgb(51, 51, 51); }
.markdown-preview code, .markdown-preview tt, .markdown-preview pre.editor-colors { font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; }
.markdown-preview a, .markdown-preview a code { color: rgb(65, 131, 196); }
.markdown-preview ol > li { list-style-type: decimal; }
.markdown-preview ul > li { list-style-type: disc; }
.markdown-preview li > pre.editor-colors { display: inline-block; vertical-align: top; width: 100%; }
.markdown-preview li:last-child > pre.editor-colors { margin-bottom: 0px; }
.markdown-preview > :first-child { margin-top: 0px !important; }
.markdown-preview > :last-child { margin-bottom: 0px !important; }
.markdown-preview a.absent { color: rgb(204, 0, 0); }
.markdown-preview a.anchor { display: block; padding-left: 30px; margin-left: -30px; cursor: pointer; position: absolute; top: 0px; left: 0px; bottom: 0px; }
.markdown-preview h1, .markdown-preview h2, .markdown-preview h3, .markdown-preview h4, .markdown-preview h5, .markdown-preview h6 { font-family: 'Helvetica Neue', Helvetica, sans-serif; margin: 20px 0px 10px; padding: 0px 0px 10px; font-weight: bold; -webkit-font-smoothing: antialiased; cursor: text; position: relative; }
.markdown-preview h1 .octicon-link, .markdown-preview h2 .octicon-link, .markdown-preview h3 .octicon-link, .markdown-preview h4 .octicon-link, .markdown-preview h5 .octicon-link, .markdown-preview h6 .octicon-link { display: none; color: rgb(0, 0, 0); }
.markdown-preview h1:hover a.anchor, .markdown-preview h2:hover a.anchor, .markdown-preview h3:hover a.anchor, .markdown-preview h4:hover a.anchor, .markdown-preview h5:hover a.anchor, .markdown-preview h6:hover a.anchor { text-decoration: none; line-height: 1; padding-left: 0px; margin-left: -22px; top: 15%; }
.markdown-preview h1:hover a.anchor .octicon-link, .markdown-preview h2:hover a.anchor .octicon-link, .markdown-preview h3:hover a.anchor .octicon-link, .markdown-preview h4:hover a.anchor .octicon-link, .markdown-preview h5:hover a.anchor .octicon-link, .markdown-preview h6:hover a.anchor .octicon-link { display: inline-block; }
.markdown-preview h1 tt, .markdown-preview h2 tt, .markdown-preview h3 tt, .markdown-preview h4 tt, .markdown-preview h5 tt, .markdown-preview h6 tt, .markdown-preview h1 code, .markdown-preview h2 code, .markdown-preview h3 code, .markdown-preview h4 code, .markdown-preview h5 code, .markdown-preview h6 code { font-size: inherit; }
.markdown-preview h1 { font-size: 28px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(221, 221, 221); color: rgb(0, 0, 0); }
.markdown-preview h2 { font-size: 24px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(238, 238, 238); color: rgb(0, 0, 0); }
.markdown-preview h3 { font-size: 18px; }
.markdown-preview h4 { font-size: 16px; }
.markdown-preview h5 { font-size: 14px; }
.markdown-preview h6 { color: rgb(119, 119, 119); font-size: 14px; }
.markdown-preview p, .markdown-preview blockquote, .markdown-preview ul, .markdown-preview ol, .markdown-preview dl, .markdown-preview table, .markdown-preview pre.editor-colors { margin: 15px 0px; }
.markdown-preview hr { border: 0px none; color: rgb(204, 204, 204); height: 4px; padding: 0px; margin: 15px 0px; background: url('data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC') 0px 0px repeat-x transparent; }
.markdown-preview > h2:first-child, .markdown-preview > h1:first-child, .markdown-preview > h1:first-child + h2, .markdown-preview > h3:first-child, .markdown-preview > h4:first-child, .markdown-preview > h5:first-child, .markdown-preview > h6:first-child { margin-top: 0px; padding-top: 0px; }
.markdown-preview a:first-child h1, .markdown-preview a:first-child h2, .markdown-preview a:first-child h3, .markdown-preview a:first-child h4, .markdown-preview a:first-child h5, .markdown-preview a:first-child h6 { margin-top: 0px; padding-top: 0px; }
.markdown-preview h1 + p, .markdown-preview h2 + p, .markdown-preview h3 + p, .markdown-preview h4 + p, .markdown-preview h5 + p, .markdown-preview h6 + p { margin-top: 0px; }
.markdown-preview li p.first { display: inline-block; }
.markdown-preview ul, .markdown-preview ol { padding-left: 30px; }
.markdown-preview ul.no-list, .markdown-preview ol.no-list { list-style-type: none; padding: 0px; }
.markdown-preview ul li > :first-child, .markdown-preview ol li > :first-child, .markdown-preview ul li ul:first-of-type, .markdown-preview ol li ul:first-of-type { margin-top: 0px; }
.markdown-preview ul ul, .markdown-preview ul ol, .markdown-preview ol ol, .markdown-preview ol ul { margin-bottom: 0px; }
.markdown-preview dl { padding: 0px; }
.markdown-preview dl dt { font-size: 14px; font-weight: bold; font-style: italic; padding: 0px; margin: 15px 0px 5px; }
.markdown-preview dl dt:first-child { padding: 0px; }
.markdown-preview dl dt > :first-child { margin-top: 0px; }
.markdown-preview dl dt > :last-child { margin-bottom: 0px; }
.markdown-preview dl dd { margin: 0px 0px 15px; padding: 0px 15px; }
.markdown-preview dl dd > :first-child { margin-top: 0px; }
.markdown-preview dl dd > :last-child { margin-bottom: 0px; }
.markdown-preview blockquote { border-left-width: 4px; border-left-style: solid; border-left-color: rgb(221, 221, 221); padding: 0px 15px; color: rgb(119, 119, 119); }
.markdown-preview blockquote > :first-child { margin-top: 0px; }
.markdown-preview blockquote > :last-child { margin-bottom: 0px; }
.markdown-preview blockquote p { font-size: 16px; line-height: 1.5; }
.markdown-preview table th { font-weight: bold; }
.markdown-preview table th, .markdown-preview table td { border: 1px solid rgb(204, 204, 204); padding: 6px 13px; }
.markdown-preview table tr { border-top-width: 1px; border-top-style: solid; border-top-color: rgb(204, 204, 204); background-color: rgb(255, 255, 255); }
.markdown-preview table tr:nth-child(2n) { background-color: rgb(248, 248, 248); }
.markdown-preview img { max-width: 100%; }
.markdown-preview span.frame { display: block; overflow: hidden; }
.markdown-preview span.frame > span { border: 1px solid rgb(221, 221, 221); display: block; float: left; overflow: hidden; margin: 13px 0px 0px; padding: 7px; width: auto; }
.markdown-preview span.frame span img { display: block; float: left; }
.markdown-preview span.frame span span { clear: both; color: rgb(51, 51, 51); display: block; padding: 5px 0px 0px; }
.markdown-preview span.align-center { display: block; overflow: hidden; clear: both; }
.markdown-preview span.align-center > span { display: block; overflow: hidden; margin: 13px auto 0px; text-align: center; }
.markdown-preview span.align-center span img { margin: 0px auto; text-align: center; }
.markdown-preview span.align-right { display: block; overflow: hidden; clear: both; }
.markdown-preview span.align-right > span { display: block; overflow: hidden; margin: 13px 0px 0px; text-align: right; }
.markdown-preview span.align-right span img { margin: 0px; text-align: right; }
.markdown-preview span.float-left { display: block; margin-right: 13px; overflow: hidden; float: left; }
.markdown-preview span.float-left span { margin: 13px 0px 0px; }
.markdown-preview span.float-right { display: block; margin-left: 13px; overflow: hidden; float: right; }
.markdown-preview span.float-right > span { display: block; overflow: hidden; margin: 13px auto 0px; text-align: right; }
.markdown-preview code, .markdown-preview tt { margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); border-radius: 3px; text-shadow: none; background-color: rgb(248, 248, 248); }
.markdown-preview code { white-space: nowrap; }
.markdown-preview pre.editor-colors { font-size: 13px; line-height: 19px; overflow: auto; padding: 6px 10px; border-radius: 3px; border: 1px solid rgb(230, 230, 230); background: rgb(255, 255, 255); }
.markdown-preview kbd { border-radius: 2px; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221) rgb(204, 204, 204) rgb(204, 204, 204) rgb(221, 221, 221); padding: 1px 4px; line-height: 10px; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-image: linear-gradient(rgb(241, 241, 241), rgb(221, 221, 221)); background-color: rgb(221, 221, 221); background-repeat: repeat-x; }
.markdown-preview .emoji { height: 20px; width: 20px; }
.gutter .line-number.linter-warning .icon-right {
  visibility: visible;
}
.gutter .line-number.linter-warning .icon-right:before {
  color: #ff982d;
  content: "\f052";
  font-size: 1.1em;
}
.gutter .line-number.linter-error .icon-right {
  visibility: visible;
}
.gutter .line-number.linter-error .icon-right:before {
  color: #cc0000;
  content: "\f052";
  font-size: 1.1em;
}

.highlight.linter-warning .region {
  background-color: #f89400;
  -webkit-mask-image: url(atom://linter/images/wave.svg);
  -webkit-mask-repeat: repeat;
  -webkit-mask-size: .9em 1.3em;
  -webkit-mask-position: bottom left;
}
.highlight.linter-error .region {
  background-color: #990000;
  -webkit-mask-image: url(atom://linter/images/wave.svg);
  -webkit-mask-repeat: repeat;
  -webkit-mask-size: .9em 1.3em;
  -webkit-mask-position: bottom left;
}

.bracket-matcher .region {
  border-bottom: 1px dotted lime;
  position: absolute;
}

.spell-check-misspelling .region {
  border-bottom: 1px dashed rgba(250, 128, 114, 0.5);
}

.editor,
.editor .gutter {
  background-color: #2D2D2D;
  color: #CCCCCC;
}
.editor.is-focused .cursor {
  border-color: #CCCCCC;
}
.editor.is-focused .selection .region {
  background-color: #515151;
}
.editor.is-focused .line-number.cursor-line-no-selection,
.editor.is-focused .line.cursor-line {
  background-color: #393939;
}
.comment {
  color: #999999;
}
.keyword.operator.class,
.constant.other,
.source.php.embedded.line {
  color: #CCCCCC;
}
.variable,
.support.other.variable,
.string.other.link,
.entity.name.tag,
.entity.other.attribute-name,
.meta.tag,
.declaration.tag {
  color: #F2777A;
}
.constant.numeric,
.constant.language,
.support.constant,
.constant.character,
.variable.parameter,
.punctuation.section.embedded,
.keyword.other.unit {
  color: #F99157;
}
.entity.name.class,
.entity.name.type.class,
.support.type,
.support.class {
  color: #FFCC66;
}
.string,
.constant.other.symbol,
.entity.other.inherited-class,
.markup.heading {
  color: #99CC99;
}
.keyword.operator,
.constant.other.color {
  color: #66CCCC;
}
.entity.name.function,
.meta.function-call,
.support.function,
.keyword.other.special-method,
.meta.block-level {
  color: #6699CC;
}
.keyword,
.storage,
.storage.type,
.entity.name.tag.css {
  color: #CC99CC;
}
.invalid {
  color: #CDCDCD;
  background-color: #F2777A;
}
.meta.separator {
  color: #CDCDCD;
  background-color: #99CCCC;
}
.invalid.deprecated {
  color: #CDCDCD;
  background-color: #CC99CC;
}
</style>
  </head>
  <body class='markdown-preview'><h1 id="mach-o-binaries">Mach-O Binaries</h1>
<blockquote>
  <p>εἰ γὰρ ὤφελον, ὦ Κρίτων, οἷοί τ᾽ εἶναι οἱ πολλοὶ τὰ μέγιστα κακὰ ἐργάζεσθαι, ἵνα οἷοί τ᾽
    ἦσαν καὶ ἀγαθὰ τὰ μέγιστα, καὶ καλῶς ἂν εἶχεν. νῦν δὲ οὐδέτερα οἷοί τε: οὔτε γὰρ
    φρόνιμον οὔτε ἄφρονα δυνατοὶ ποιῆσαι, ποιοῦσι δὲ τοῦτο ὅτι ἂν τύχωσι.</p>
</blockquote>
<p><img src="lib_dependency_graph.png" alt="/usr/lib dependencies"></p>
<p>This is a writeup detailing some of the peculiarities of the mach binary format.</p>
<p>There are several resources available locally, and on the internet, but none of them were/are very comprehensive:</p>
<ul>
<li>Apple C headers, primarily check out:<ol>
<li><code>/usr/include/mach-o/loader.h</code> (I&#39;ve read this header so many times it&#39;s probably embarassing; what&#39;s more embarassing though are the typos and the grammatically incorrect sentences commenting important structures)</li>
<li>and to a lesser extent, <code>/usr/include/mach-o/stab.h</code> and <code>/usr/include/mach-o/nlist.h</code></li>
</ol>
</li>
<li>Old article <a href="http://newosxbook.com/articles/DYLD.html">mostly about dyld</a>. The bind opcode discussion somewhat helpful, but very incomplete</li>
<li>Read up on your <a href="http://en.wikipedia.org/wiki/LEB128">Leb128</a> byte streams</li>
<li>But if you need to <em>really</em> figure out the bind opcodes, you should just slog through the <a href="https://opensource.apple.com/source/dyld/dyld-353.2.1/src/ImageLoaderMachOCompressed.cpp">dyld source code</a>, paying particular attention to the method <code>ImageLoaderMachOCompressed::eachBind</code></li>
<li>And once you&#39;re done figuring out the bind opcodes, in order to understand mach exports you should cross reference the comments in <code>/usr/include/mach-o/loader.h</code> for the <code>dyld_info_command</code> struct with two methods in dyld&#39;s source code for loading modern &quot;compressed&quot; binary images (<code>ImageLoaderMachOCompressed.cpp</code>): <code>ImageLoaderMachOCompressed::trieWalk</code> and <code>ImageLoaderMachOCompressed::findExportedSymbol</code>.  Hint: it&#39;s a <a href="http://en.wikipedia.org/wiki/Trie">trie</a>.</li>
</ul>
<p>I&#39;m sure there are other resources, but they&#39;re usually old.  I couldn&#39;t find much, sorry.  </p>
<p>Mostly, this is simply a record so I do not forget.</p>
<h2 id="load-commands">Load Commands</h2>
<p>So, after the mach header (which I won&#39;t detail here), a mach binary has a sequence of load commands.  A simple C program like:</p>
<pre class="editor-colors lang-c"><div class="line"><span class="source c"><span>#include&lt;stdio.h&gt;</span></span></div><div class="line"><span class="source c"><span>&nbsp;</span></span></div><div class="line"><span class="source c"><span class="storage type c"><span>long</span></span><span>&nbsp;</span><span class="storage type c"><span>int</span></span><span class="meta function c"><span class="punctuation whitespace function leading c"><span>&nbsp;</span></span><span class="entity name function c"><span>maximum</span></span><span class="meta parens c"><span class="punctuation section parens begin c"><span>(</span></span><span class="storage type c"><span>long</span></span><span>&nbsp;</span><span class="storage type c"><span>int</span></span><span>&nbsp;x,&nbsp;</span><span class="storage type c"><span>long</span></span><span>&nbsp;</span><span class="storage type c"><span>int</span></span><span>&nbsp;y</span><span class="punctuation section parens end c"><span>)</span></span></span><span class="meta block c"><span class="punctuation section block begin c"><span>{</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;</span><span class="keyword control c"><span>return</span></span><span>&nbsp;x&nbsp;&gt;&nbsp;y&nbsp;?&nbsp;x&nbsp;:&nbsp;y;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="punctuation section block end c"><span>}</span></span></span></span></span></div><div class="line"><span class="source c"><span>&nbsp;</span></span></div><div class="line"><span class="source c"><span class="storage type c"><span>int</span></span><span class="meta function c"><span class="punctuation whitespace function leading c"><span>&nbsp;</span></span><span class="entity name function c"><span>main</span></span><span>&nbsp;</span><span class="meta parens c"><span class="punctuation section parens begin c"><span>(</span></span><span class="punctuation section parens end c"><span>)</span></span></span><span class="meta block c"><span class="punctuation section block begin c"><span>{</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;</span><span class="storage type c"><span>long</span></span><span>&nbsp;</span><span class="storage type c"><span>int</span></span><span>&nbsp;max&nbsp;=</span><span class="meta function-call c"><span class="punctuation whitespace function-call leading c"><span>&nbsp;</span></span><span class="support function any-method c"><span>maximum</span></span><span>(</span></span><span class="constant numeric c"><span>2</span></span><span>,</span><span class="constant numeric c"><span>3</span></span><span>);</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="punctuation whitespace support function leading c"><span>&nbsp;&nbsp;</span></span><span class="support function C99 c"><span>printf</span></span><span>(</span><span class="string quoted double c"><span class="punctuation definition string begin c"><span>&quot;</span></span><span>max:&nbsp;</span><span class="constant other placeholder c"><span>%lu</span></span><span class="constant character escape c"><span>\n</span></span><span class="punctuation definition string end c"><span>&quot;</span></span></span><span>,&nbsp;max);</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;</span><span class="keyword control c"><span>return</span></span><span>&nbsp;</span><span class="constant numeric c"><span>0</span></span><span>;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="punctuation section block end c"><span>}</span></span></span></span></span></div></pre>
<p>will probably contain about 15-16 load commands.  Load commands essentially contain important information like:</p>
<ul>
<li>where the segments are (the place where code and data are in the binary), <code>LC_SEGMENT_64</code> for 64 bit binaries</li>
<li>whether it&#39;s a library, <code>LC_ID_DYLIB</code> (or its soname if you&#39;re coming from a linux background)</li>
<li>what libraries it imports,  <code>LC_LOAD_DYLIB</code> et. al. (which is important for OSX&#39;s support for two-level namespaces, which are awesome BTW)</li>
<li>what program interpreter it uses, <code>LC_LOAD_DYLINKER</code>, usually <code>/usr/lib/dyld</code></li>
<li>where the main entry point is, <code>LC_MAIN</code> ( for OSX10.5 or greater: before that it&#39;s <code>LC_UNIXTHREAD</code>, which requires the link editor to embed <code>/usr/lib/crt1.o</code> in every binary, which sets up the stack, etc.)</li>
<li>the all-important <code>LC_DYLD_INFO_ONLY</code> (or <code>LC_DYLD_INFO</code>), which is essentially OSX&#39;s <code>_DYNAMIC</code>, or the place where you can get all the information you need for imports and exports (even when the binary is stripped)</li>
<li>the linux/bsd nlist symbol table, given by <code>LC_SYMTAB</code>, which can be stripped</li>
<li>and so on and so forth.</li>
</ul>
<p>If you compile the above C program with something like <code>gcc -o max max.c</code>, you can use a tool like <code>otool -l max</code> to look at the load commands.  <code>otool</code> is OSX&#39;s <code>objdump</code>, sort of.</p>
<p>My way cooler program (currently) outputs:</p>
<pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>MachO&nbsp;x86-64&nbsp;EXECUTE</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>(&nbsp;0):&nbsp;SEGMENT_64&nbsp;(0x19)&nbsp;72</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>(&nbsp;1):&nbsp;SEGMENT_64&nbsp;(0x19)&nbsp;552</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>(&nbsp;2):&nbsp;SEGMENT_64&nbsp;(0x19)&nbsp;232</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>(&nbsp;3):&nbsp;SEGMENT_64&nbsp;(0x19)&nbsp;72</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>(&nbsp;4):&nbsp;DYLD_INFO_ONLY&nbsp;(0x80000022)&nbsp;48</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta paragraph text"><span>rebase_off:&nbsp;0x2000&nbsp;rebase_size:&nbsp;8</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>&nbsp;&nbsp;&nbsp;&nbsp;bind_off:&nbsp;0x2008&nbsp;bind_size:&nbsp;24</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>&nbsp;&nbsp;&nbsp;&nbsp;weak_bind_off:&nbsp;0x0&nbsp;weak_bind_size:&nbsp;0</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>&nbsp;&nbsp;&nbsp;&nbsp;lazy_bind_off:&nbsp;0x2020&nbsp;lazy_bind_size:&nbsp;16</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>&nbsp;&nbsp;&nbsp;&nbsp;export_off:&nbsp;0x2030&nbsp;export_size:&nbsp;64</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>(&nbsp;5):&nbsp;SYMTAB&nbsp;(0x2)&nbsp;24</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta paragraph text"><span>symoff:&nbsp;0x20b8&nbsp;nsyms:&nbsp;5&nbsp;stroff:&nbsp;0x2118&nbsp;strsize:&nbsp;64</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>(&nbsp;6):&nbsp;DYSYMTAB&nbsp;(0xb)&nbsp;80</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta paragraph text"><span>ilocalsym:&nbsp;0x0&nbsp;nlocalsym:&nbsp;0&nbsp;iextdefsym:&nbsp;0x0&nbsp;nextdefsym:&nbsp;3</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>&nbsp;&nbsp;&nbsp;&nbsp;iundefsym:&nbsp;0x3&nbsp;nundefsym:&nbsp;2&nbsp;tocoff:&nbsp;0x0&nbsp;ntoc:&nbsp;0</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>&nbsp;&nbsp;&nbsp;&nbsp;modtaboff:&nbsp;0x0&nbsp;nmodtab:&nbsp;0&nbsp;extrefsymoff:&nbsp;0x0&nbsp;nextrefsyms:&nbsp;0</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>&nbsp;&nbsp;&nbsp;&nbsp;indirectsymoff:&nbsp;0x2108&nbsp;nindirectsyms:&nbsp;4&nbsp;extreloff:&nbsp;0x0&nbsp;nextrel:&nbsp;0</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>&nbsp;&nbsp;&nbsp;&nbsp;locreloff:&nbsp;0x0&nbsp;nlocrel:&nbsp;0</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>(&nbsp;7):&nbsp;LOAD_DYLINKER&nbsp;(0xe)&nbsp;32</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>(&nbsp;8):&nbsp;UUID&nbsp;(0x1b)&nbsp;24</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>(&nbsp;9):&nbsp;VERSION_MIN_MACOSX&nbsp;(0x24)&nbsp;16</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta paragraph text"><span>version:&nbsp;OSX&nbsp;10.10&nbsp;sdk:&nbsp;OSX&nbsp;10.10</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>(10):&nbsp;SOURCE_VERSION&nbsp;(0x2a)&nbsp;16</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>(11):&nbsp;MAIN&nbsp;(0x80000028)&nbsp;24</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta paragraph text"><span>offset:&nbsp;0xf50&nbsp;stacksize:&nbsp;0x0</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>(12):&nbsp;LOAD_DYLIB&nbsp;(0xc)&nbsp;56</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta paragraph text"><span>/usr/lib/libSystem.B.dylib</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>(13):&nbsp;FUNCTION_STARTS&nbsp;(0x26)&nbsp;16</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>(14):&nbsp;DATA_IN_CODE&nbsp;(0x29)&nbsp;16</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>(15):&nbsp;DYLIB_CODE_SIGN_DRS&nbsp;(0x2b)&nbsp;16</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>Libraries&nbsp;(1)</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>Exports&nbsp;(3)</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>Imports&nbsp;(2)</span></span></span></div></pre><h2 id="libraries">Libraries</h2>
<p>OSX, for better or worse (better), uses a two-level namespace for resolving undefined symbol references (imports).  What that means is that imported symbols have a pointer to <em>which</em> library they&#39;re from; which is <em>awesome</em>.</p>
<p>If you&#39;ve got a million imports, do you know how a flat namespace dynamic library loader will resolve that undefined symbol?  Yes, it will load each referenced library,  searching its exported symbols until it finds a match, and then returns that symbol (or rather the offset to the symbol + the virtual memory address of the dylib in the plt or got).</p>
<p>So for flat namespace lookups:</p>
<ol>
<li>Symbol lookup is linear in the size of the number of imported symbols, in the worst case</li>
<li>The first match is the resolved symbol, so the chance of namespace collisions and using the wrong symbol (at no fault of your own), is more likely.  But then again, library writers probably shouldn&#39;t be naming their symbols &quot;foo&quot; anyway.</li>
</ol>
<p>Moreover, from a static analysis perspective, two level namespaces make it easier to analyze binaries, their dependencies, etc., since the imports tell you where they come from, statically, so you don&#39;t have to run the program, like <code>ldd</code> does, which is safer from a security perspective.</p>
<p>Of course this kind of simple static analysis won&#39;t catch dynamic loading of libraries at runtime using the standard api at <code>/usr/include/dlfcn.h</code>, but, like, whatever, man.</p>
<p>Returning to mach imports, while there are some edge cases, which I&#39;ll detail in the imports section, basically the pointer is an index to what can be thought of as an array of libraries.  The array is formed by taking the libraries in the order they appear in the load commands, and indexing them in that manner, <strong>starting from 1</strong>.</p>
<p>So if I have two libraries, <code>/usr/lib/libfoo.1.dylib</code> and <code>/usr/lib/libbar.1.dylib</code>, and 3 imported symbols, they will either have 1 or 2 as their index, for <code>libfoo</code> and <code>libbar</code>, respectively.</p>
<p>A binary can also reference libraries using variable path prefixes, of which there are three:</p>
<ul>
<li><code>@rpath</code></li>
<li><code>@executable_path</code></li>
<li><code>@loader_path</code></li>
</ul>
<p>You&#39;ll typically come across <code>@rpath</code>; if you feel like hacking around with your own dylib, you&#39;ll probably use <code>@rpath</code> or <code>@executable_path</code>.  </p>
<p>You should probably read the Apple <a href="https://developer.apple.com/library/mac/documentation/DeveloperTools/Conceptual/DynamicLibraries/100-Articles/RunpathDependentLibraries.html">runpath dependent library documentation</a>, if you&#39;re more curious, because I always forget the exact details.</p>
<h2 id="symbols">Symbols</h2>
<p>All mach imported and exported symbol information is contained in the linkedit segment.</p>
<p>The linkedit segment is usually described by the last <code>LC_SEGMENT_64</code> load command, with the descriptive name &quot;__LINKEDIT&quot;; it contains lots of information, like the nlist symbol table, and the imports, as well as code signing details, rebasing and relocation info, etc.</p>
<p>If you&#39;re curious, the first place you should head to is <code>/usr/lib/mach-o/loader.h</code> (once again) and find the <code>dyld_info_command</code> struct, where a comment like this (as of March 2015) awaits you:</p>
<blockquote>
<p>The dyld_info_command contains the file offsets and sizes of
the new compressed form of the information dyld needs to
load the image.  This information is used by dyld on Mac OS X
10.6 and later.  All information pointed to by this command
is encoded using byte streams, so no endian swapping is needed
to interpret it.</p>
</blockquote>
<p>Byte streams?  If you haven&#39;t already, time to go learn <a href="http://en.wikipedia.org/wiki/LEB128#Unsigned_LEB128">Uleb128</a> and <a href="http://en.wikipedia.org/wiki/LEB128#Signed_LEB128">Sleb128</a>, and preferably implement it.</p>
<p>For future posterity and reference, let&#39;s actually just put the whole struct declaration from the header, glorious comments and all, right here:</p>
<pre class="editor-colors lang-c"><div class="line"><span class="source c"><span class="storage type c"><span>struct</span></span><span>&nbsp;dyld_info_command&nbsp;</span><span class="meta block c"><span class="punctuation section block begin c"><span>{</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;</span><span class="support type stdint c"><span>uint32_t</span></span><span>&nbsp;&nbsp;&nbsp;cmd;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span><span>&nbsp;LC_DYLD_INFO&nbsp;or&nbsp;LC_DYLD_INFO_ONLY&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;</span><span class="support type stdint c"><span>uint32_t</span></span><span>&nbsp;&nbsp;&nbsp;cmdsize;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span><span>&nbsp;sizeof(struct&nbsp;dyld_info_command)&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;</span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Dyld&nbsp;rebases&nbsp;an&nbsp;image&nbsp;whenever&nbsp;dyld&nbsp;loads&nbsp;it&nbsp;at&nbsp;an&nbsp;address&nbsp;different</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;from&nbsp;its&nbsp;preferred&nbsp;address.&nbsp;&nbsp;The&nbsp;rebase&nbsp;information&nbsp;is&nbsp;a&nbsp;stream</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;of&nbsp;byte&nbsp;sized&nbsp;opcodes&nbsp;whose&nbsp;symbolic&nbsp;names&nbsp;start&nbsp;with&nbsp;REBASE_OPCODE_.</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Conceptually&nbsp;the&nbsp;rebase&nbsp;information&nbsp;is&nbsp;a&nbsp;table&nbsp;of&nbsp;tuples:</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&lt;seg-index,&nbsp;seg-offset,&nbsp;type&gt;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;opcodes&nbsp;are&nbsp;a&nbsp;compressed&nbsp;way&nbsp;to&nbsp;encode&nbsp;the&nbsp;table&nbsp;by&nbsp;only</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;encoding&nbsp;when&nbsp;a&nbsp;column&nbsp;changes.&nbsp;&nbsp;In&nbsp;addition&nbsp;simple&nbsp;patterns</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;like&nbsp;&quot;every&nbsp;n&#39;th&nbsp;offset&nbsp;for&nbsp;m&nbsp;times&quot;&nbsp;can&nbsp;be&nbsp;encoded&nbsp;in&nbsp;a&nbsp;few</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;bytes.</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support type stdint c"><span>uint32_t</span></span><span>&nbsp;&nbsp;&nbsp;rebase_off;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span><span>&nbsp;file&nbsp;offset&nbsp;to&nbsp;rebase&nbsp;info&nbsp;&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support type stdint c"><span>uint32_t</span></span><span>&nbsp;&nbsp;&nbsp;rebase_size;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span><span>&nbsp;size&nbsp;of&nbsp;rebase&nbsp;info&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;</span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Dyld&nbsp;binds&nbsp;an&nbsp;image&nbsp;during&nbsp;the&nbsp;loading&nbsp;process,&nbsp;if&nbsp;the&nbsp;image</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;requires&nbsp;any&nbsp;pointers&nbsp;to&nbsp;be&nbsp;initialized&nbsp;to&nbsp;symbols&nbsp;in&nbsp;other&nbsp;images.&nbsp;&nbsp;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;bind&nbsp;information&nbsp;is&nbsp;a&nbsp;stream&nbsp;of&nbsp;byte&nbsp;sized</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;opcodes&nbsp;whose&nbsp;symbolic&nbsp;names&nbsp;start&nbsp;with&nbsp;BIND_OPCODE_.</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Conceptually&nbsp;the&nbsp;bind&nbsp;information&nbsp;is&nbsp;a&nbsp;table&nbsp;of&nbsp;tuples:</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&lt;seg-index,&nbsp;seg-offset,&nbsp;type,&nbsp;symbol-library-ordinal,&nbsp;symbol-name,&nbsp;addend&gt;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;opcodes&nbsp;are&nbsp;a&nbsp;compressed&nbsp;way&nbsp;to&nbsp;encode&nbsp;the&nbsp;table&nbsp;by&nbsp;only</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;encoding&nbsp;when&nbsp;a&nbsp;column&nbsp;changes.&nbsp;&nbsp;In&nbsp;addition&nbsp;simple&nbsp;patterns</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;like&nbsp;for&nbsp;runs&nbsp;of&nbsp;pointers&nbsp;initialzed&nbsp;to&nbsp;the&nbsp;same&nbsp;value&nbsp;can&nbsp;be</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;encoded&nbsp;in&nbsp;a&nbsp;few&nbsp;bytes.</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support type stdint c"><span>uint32_t</span></span><span>&nbsp;&nbsp;&nbsp;bind_off;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span><span>&nbsp;file&nbsp;offset&nbsp;to&nbsp;binding&nbsp;info&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support type stdint c"><span>uint32_t</span></span><span>&nbsp;&nbsp;&nbsp;bind_size;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span><span>&nbsp;size&nbsp;of&nbsp;binding&nbsp;info&nbsp;&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;</span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Some&nbsp;C++&nbsp;programs&nbsp;require&nbsp;dyld&nbsp;to&nbsp;unique&nbsp;symbols&nbsp;so&nbsp;that&nbsp;all</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;images&nbsp;in&nbsp;the&nbsp;process&nbsp;use&nbsp;the&nbsp;same&nbsp;copy&nbsp;of&nbsp;some&nbsp;code/data.</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;This&nbsp;step&nbsp;is&nbsp;done&nbsp;after&nbsp;binding.&nbsp;The&nbsp;content&nbsp;of&nbsp;the&nbsp;weak_bind</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;info&nbsp;is&nbsp;an&nbsp;opcode&nbsp;stream&nbsp;like&nbsp;the&nbsp;bind_info.&nbsp;&nbsp;But&nbsp;it&nbsp;is&nbsp;sorted</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;alphabetically&nbsp;by&nbsp;symbol&nbsp;name.&nbsp;&nbsp;This&nbsp;enable&nbsp;dyld&nbsp;to&nbsp;walk</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;all&nbsp;images&nbsp;with&nbsp;weak&nbsp;binding&nbsp;information&nbsp;in&nbsp;order&nbsp;and&nbsp;look</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;for&nbsp;collisions.&nbsp;&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;collisions,&nbsp;dyld&nbsp;does</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;no&nbsp;updating.&nbsp;&nbsp;That&nbsp;means&nbsp;that&nbsp;some&nbsp;fixups&nbsp;are&nbsp;also&nbsp;encoded</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;in&nbsp;the&nbsp;bind_info.&nbsp;&nbsp;For&nbsp;instance,&nbsp;all&nbsp;calls&nbsp;to&nbsp;&quot;operator&nbsp;new&quot;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;are&nbsp;first&nbsp;bound&nbsp;to&nbsp;libstdc++.dylib&nbsp;using&nbsp;the&nbsp;information</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;in&nbsp;bind_info.&nbsp;&nbsp;Then&nbsp;if&nbsp;some&nbsp;image&nbsp;overrides&nbsp;operator&nbsp;new</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;that&nbsp;is&nbsp;detected&nbsp;when&nbsp;the&nbsp;weak_bind&nbsp;information&nbsp;is&nbsp;processed</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;and&nbsp;the&nbsp;call&nbsp;to&nbsp;operator&nbsp;new&nbsp;is&nbsp;then&nbsp;rebound.</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support type stdint c"><span>uint32_t</span></span><span>&nbsp;&nbsp;&nbsp;weak_bind_off;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span><span>&nbsp;file&nbsp;offset&nbsp;to&nbsp;weak&nbsp;binding&nbsp;info&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support type stdint c"><span>uint32_t</span></span><span>&nbsp;&nbsp;&nbsp;weak_bind_size;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span><span>&nbsp;size&nbsp;of&nbsp;weak&nbsp;binding&nbsp;info&nbsp;&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;</span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Some&nbsp;uses&nbsp;of&nbsp;external&nbsp;symbols&nbsp;do&nbsp;not&nbsp;need&nbsp;to&nbsp;be&nbsp;bound&nbsp;immediately.</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Instead&nbsp;they&nbsp;can&nbsp;be&nbsp;lazily&nbsp;bound&nbsp;on&nbsp;first&nbsp;use.&nbsp;&nbsp;The&nbsp;lazy_bind</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;are&nbsp;contains&nbsp;a&nbsp;stream&nbsp;of&nbsp;BIND&nbsp;opcodes&nbsp;to&nbsp;bind&nbsp;all&nbsp;lazy&nbsp;symbols.</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Normal&nbsp;use&nbsp;is&nbsp;that&nbsp;dyld&nbsp;ignores&nbsp;the&nbsp;lazy_bind&nbsp;section&nbsp;when</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;loading&nbsp;an&nbsp;image.&nbsp;&nbsp;Instead&nbsp;the&nbsp;static&nbsp;linker&nbsp;arranged&nbsp;for&nbsp;the</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;lazy&nbsp;pointer&nbsp;to&nbsp;initially&nbsp;point&nbsp;to&nbsp;a&nbsp;helper&nbsp;function&nbsp;which</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;pushes&nbsp;the&nbsp;offset&nbsp;into&nbsp;the&nbsp;lazy_bind&nbsp;area&nbsp;for&nbsp;the&nbsp;symbol</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;needing&nbsp;to&nbsp;be&nbsp;bound,&nbsp;then&nbsp;jumps&nbsp;to&nbsp;dyld&nbsp;which&nbsp;simply&nbsp;adds</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;offset&nbsp;to&nbsp;lazy_bind_off&nbsp;to&nbsp;get&nbsp;the&nbsp;information&nbsp;on&nbsp;what</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;to&nbsp;bind.&nbsp;&nbsp;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support type stdint c"><span>uint32_t</span></span><span>&nbsp;&nbsp;&nbsp;lazy_bind_off;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span><span>&nbsp;file&nbsp;offset&nbsp;to&nbsp;lazy&nbsp;binding&nbsp;info&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support type stdint c"><span>uint32_t</span></span><span>&nbsp;&nbsp;&nbsp;lazy_bind_size;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span><span>&nbsp;size&nbsp;of&nbsp;lazy&nbsp;binding&nbsp;infs&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;</span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;symbols&nbsp;exported&nbsp;by&nbsp;a&nbsp;dylib&nbsp;are&nbsp;encoded&nbsp;in&nbsp;a&nbsp;trie.&nbsp;&nbsp;This</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;is&nbsp;a&nbsp;compact&nbsp;representation&nbsp;that&nbsp;factors&nbsp;out&nbsp;common&nbsp;prefixes.</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;It&nbsp;also&nbsp;reduces&nbsp;LINKEDIT&nbsp;pages&nbsp;in&nbsp;RAM&nbsp;because&nbsp;it&nbsp;encodes&nbsp;all&nbsp;&nbsp;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;information&nbsp;(name,&nbsp;address,&nbsp;flags)&nbsp;in&nbsp;one&nbsp;small,&nbsp;contiguous&nbsp;range.</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;export&nbsp;area&nbsp;is&nbsp;a&nbsp;stream&nbsp;of&nbsp;nodes.&nbsp;&nbsp;The&nbsp;first&nbsp;node&nbsp;sequentially</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;is&nbsp;the&nbsp;start&nbsp;node&nbsp;for&nbsp;the&nbsp;trie.&nbsp;&nbsp;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Nodes&nbsp;for&nbsp;a&nbsp;symbol&nbsp;start&nbsp;with&nbsp;a&nbsp;uleb128&nbsp;that&nbsp;is&nbsp;the&nbsp;length&nbsp;of</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;exported&nbsp;symbol&nbsp;information&nbsp;for&nbsp;the&nbsp;string&nbsp;so&nbsp;far.</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;exported&nbsp;symbol,&nbsp;the&nbsp;node&nbsp;starts&nbsp;with&nbsp;a&nbsp;zero&nbsp;byte.</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;there&nbsp;is&nbsp;exported&nbsp;info,&nbsp;it&nbsp;follows&nbsp;the&nbsp;length.&nbsp;&nbsp;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;First&nbsp;is&nbsp;a&nbsp;uleb128&nbsp;containing&nbsp;flags.&nbsp;Normally,&nbsp;it&nbsp;is&nbsp;followed&nbsp;by</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;a&nbsp;uleb128&nbsp;encoded&nbsp;offset&nbsp;which&nbsp;is&nbsp;location&nbsp;of&nbsp;the&nbsp;content&nbsp;named</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;by&nbsp;the&nbsp;symbol&nbsp;from&nbsp;the&nbsp;mach_header&nbsp;for&nbsp;the&nbsp;image.&nbsp;&nbsp;If&nbsp;the&nbsp;flags</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;is&nbsp;EXPORT_SYMBOL_FLAGS_REEXPORT,&nbsp;then&nbsp;following&nbsp;the&nbsp;flags&nbsp;is</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;a&nbsp;uleb128&nbsp;encoded&nbsp;library&nbsp;ordinal,&nbsp;then&nbsp;a&nbsp;zero&nbsp;terminated</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;UTF8&nbsp;string.&nbsp;&nbsp;If&nbsp;the&nbsp;string&nbsp;is&nbsp;zero&nbsp;length,&nbsp;then&nbsp;the&nbsp;symbol</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;is&nbsp;re-export&nbsp;from&nbsp;the&nbsp;specified&nbsp;dylib&nbsp;with&nbsp;the&nbsp;same&nbsp;name.</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;If&nbsp;the&nbsp;flags&nbsp;is&nbsp;EXPORT_SYMBOL_FLAGS_STUB_AND_RESOLVER,&nbsp;then&nbsp;following</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;flags&nbsp;is&nbsp;two&nbsp;uleb128s:&nbsp;the&nbsp;stub&nbsp;offset&nbsp;and&nbsp;the&nbsp;resolver&nbsp;offset.</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;stub&nbsp;is&nbsp;used&nbsp;by&nbsp;non-lazy&nbsp;pointers.&nbsp;&nbsp;The&nbsp;resolver&nbsp;is&nbsp;used</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;by&nbsp;lazy&nbsp;pointers&nbsp;and&nbsp;must&nbsp;be&nbsp;called&nbsp;to&nbsp;get&nbsp;the&nbsp;actual&nbsp;address&nbsp;to&nbsp;use.</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;After&nbsp;the&nbsp;optional&nbsp;exported&nbsp;symbol&nbsp;information&nbsp;is&nbsp;a&nbsp;byte&nbsp;of</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;how&nbsp;many&nbsp;edges&nbsp;(0-255)&nbsp;that&nbsp;this&nbsp;node&nbsp;has&nbsp;leaving&nbsp;it,</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;followed&nbsp;by&nbsp;each&nbsp;edge.</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Each&nbsp;edge&nbsp;is&nbsp;a&nbsp;zero&nbsp;terminated&nbsp;UTF8&nbsp;of&nbsp;the&nbsp;addition&nbsp;chars</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;in&nbsp;the&nbsp;symbol,&nbsp;followed&nbsp;by&nbsp;a&nbsp;uleb128&nbsp;offset&nbsp;for&nbsp;the&nbsp;node&nbsp;that</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;edge&nbsp;points&nbsp;to.</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="comment block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support type stdint c"><span>uint32_t</span></span><span>&nbsp;&nbsp;&nbsp;export_off;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span><span>&nbsp;file&nbsp;offset&nbsp;to&nbsp;lazy&nbsp;binding&nbsp;info&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support type stdint c"><span>uint32_t</span></span><span>&nbsp;&nbsp;&nbsp;export_size;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span><span>&nbsp;size&nbsp;of&nbsp;lazy&nbsp;binding&nbsp;infs&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="punctuation section block end c"><span>}</span></span></span><span>;</span></span></div></pre>
<p>The various offset and size values in the struct fields contain all the information one needs to extract the imported and exported symbols in a binary, <strong><em>even after stripping</em></strong>.</p>
<p>Mach exports and mach imports use a trie, and a finite state automaton, respectively, to compress their information.  Time to brush the dust off that old CS theory book.</p>
<h3 id="exports">Exports</h3>
<p>Mach exports, or globally visible symbols, or things you can link against without error, or &quot;a subset of the things you are able to reference in a C header file&quot;, reside in the linkedit segment, in a data structure called a trie which you probably learned about in your CS Algorithms I class, and then promptly forgot.  </p>
<p>And now here comes the pain (actually this is probably the coolest part of mach binaries, once you figure it out, in spite of the obtuse and questionably grammatical documentation).</p>
<p>To better illustrate this point, it helps to have a very simple dynamic library.</p>
<p>Here you go:</p>
<pre class="editor-colors lang-c"><div class="line"><span class="source c"><span class="comment line double-slash c++"><span class="punctuation definition comment c++"><span>//</span></span><span>libtoc.c</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source c"><span class="storage type c"><span>int</span></span><span>&nbsp;toc_extern_export&nbsp;=&nbsp;</span><span class="constant numeric c"><span>0xb1b1eb0b</span></span><span>;</span></span></div><div class="line"><span class="source c"><span class="storage modifier c"><span>const</span></span><span>&nbsp;</span><span class="storage type c"><span>long</span></span><span>&nbsp;</span><span class="constant other variable mac-classic c"><span>kTOC_MAGICAL_FUN</span></span><span>&nbsp;=&nbsp;</span><span class="constant numeric c"><span>0xdeadbeef</span></span><span>;</span></span></div><div class="line"><span class="source c"><span>&nbsp;</span></span></div><div class="line"><span class="source c"><span class="storage type c"><span>long</span></span><span>&nbsp;</span><span class="storage type c"><span>int</span></span><span class="meta function c"><span class="punctuation whitespace function leading c"><span>&nbsp;</span></span><span class="entity name function c"><span>toc_maximum</span></span><span class="meta parens c"><span class="punctuation section parens begin c"><span>(</span></span><span class="storage type c"><span>long</span></span><span>&nbsp;</span><span class="storage type c"><span>int</span></span><span>&nbsp;x,&nbsp;</span><span class="storage type c"><span>long</span></span><span>&nbsp;</span><span class="storage type c"><span>int</span></span><span>&nbsp;y</span><span class="punctuation section parens end c"><span>)</span></span></span><span class="meta block c"><span class="punctuation section block begin c"><span>{</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;</span><span class="keyword control c"><span>return</span></span><span>&nbsp;x&nbsp;&gt;&nbsp;y&nbsp;?&nbsp;x&nbsp;:&nbsp;y;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="punctuation section block end c"><span>}</span></span></span></span></span></div><div class="line"><span class="source c"><span>&nbsp;</span></span></div><div class="line"><span class="source c"><span class="storage type c"><span>long</span></span><span>&nbsp;</span><span class="storage type c"><span>int</span></span><span class="meta function c"><span class="punctuation whitespace function leading c"><span>&nbsp;</span></span><span class="entity name function c"><span>toc_XX_unicode</span></span><span class="meta parens c"><span class="punctuation section parens begin c"><span>(</span></span><span class="storage type c"><span>long</span></span><span>&nbsp;</span><span class="storage type c"><span>int</span></span><span>&nbsp;x,&nbsp;</span><span class="storage type c"><span>long</span></span><span>&nbsp;</span><span class="storage type c"><span>int</span></span><span>&nbsp;y</span><span class="punctuation section parens end c"><span>)</span></span></span><span class="meta block c"><span class="punctuation section block begin c"><span>{</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;</span><span class="keyword control c"><span>return</span></span><span>&nbsp;x&nbsp;*&nbsp;y&nbsp;&lt;&lt;&nbsp;</span><span class="constant numeric c"><span>2</span></span><span>;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="punctuation section block end c"><span>}</span></span></span></span></span></div></pre>
<pre class="editor-colors lang-c"><div class="line"><span class="source c"><span class="comment line double-slash c++"><span class="punctuation definition comment c++"><span>//</span></span><span>libtoc.h</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source c"><span class="meta preprocessor c"><span>#</span><span class="keyword control import c"><span>ifndef</span></span><span>&nbsp;_LIBTOC_H_</span></span></span></div><div class="line"><span class="source c"><span class="meta preprocessor macro c"><span>#</span><span class="keyword control import define c"><span>define</span></span><span>&nbsp;</span><span class="entity name function preprocessor c"><span>_LIBTOC_H_</span></span></span></span></div><div class="line"><span class="source c"><span class="storage modifier c"><span>extern</span></span><span>&nbsp;</span><span class="storage modifier c"><span>const</span></span><span>&nbsp;</span><span class="storage type c"><span>long</span></span><span>&nbsp;</span><span class="constant other variable mac-classic c"><span>kTOC_MAGICAL_FUN</span></span><span>;</span></span></div><div class="line"><span class="source c"><span>&nbsp;</span></span></div><div class="line"><span class="source c"><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span></span></span></div><div class="line"><span class="source c"><span class="comment block c"><span>&nbsp;a&nbsp;constant&nbsp;definition&nbsp;&quot;exported&quot;&nbsp;by&nbsp;library</span></span></span></div><div class="line"><span class="source c"><span class="comment block c"><span>&nbsp;i&nbsp;quote&nbsp;it&nbsp;because&nbsp;it&nbsp;isn&#39;t&nbsp;really&nbsp;exported,&nbsp;as&nbsp;it&nbsp;doesn&#39;t&nbsp;show&nbsp;up&nbsp;in&nbsp;the&nbsp;exports&nbsp;anywhere</span></span></span></div><div class="line"><span class="source c"><span class="comment block c"><span>&nbsp;it&nbsp;basically&nbsp;exists&nbsp;emphemerally&nbsp;in&nbsp;any&nbsp;source&nbsp;code&nbsp;which&nbsp;#includes&nbsp;this&nbsp;header,</span></span></span></div><div class="line"><span class="source c"><span class="comment block c"><span>&nbsp;and&nbsp;then&nbsp;disappears&nbsp;after&nbsp;compilation,</span></span></span></div><div class="line"><span class="source c"><span class="comment block c"><span>&nbsp;as&nbsp;no&nbsp;symbol&nbsp;is&nbsp;associated&nbsp;with&nbsp;it,&nbsp;and&nbsp;it&nbsp;returns&nbsp;to&nbsp;it&#39;s&nbsp;pure&nbsp;anonymous,</span></span></span></div><div class="line"><span class="source c"><span class="comment block c"><span>&nbsp;integer&nbsp;brothers&nbsp;and&nbsp;sisters</span></span></span></div><div class="line"><span class="source c"><span class="comment block c"><span>&nbsp;of&nbsp;course&nbsp;this&nbsp;has&nbsp;advantages&nbsp;wrt&nbsp;client&nbsp;side&nbsp;speed,&nbsp;since&nbsp;the&nbsp;value&nbsp;can</span></span></span></div><div class="line"><span class="source c"><span class="comment block c"><span>&nbsp;typically&nbsp;be&nbsp;used&nbsp;as&nbsp;an&nbsp;immediate,&nbsp;no&nbsp;memory&nbsp;reads&nbsp;are&nbsp;performed,</span></span></span></div><div class="line"><span class="source c"><span class="comment block c"><span>&nbsp;and&nbsp;the&nbsp;dynamic&nbsp;linker&nbsp;doesn&#39;t&nbsp;have&nbsp;to&nbsp;load&nbsp;the&nbsp;value&nbsp;into&nbsp;the&nbsp;got</span></span></span></div><div class="line"><span class="source c"><span class="comment block c"><span class="punctuation definition comment end c"><span>*/</span></span></span></span></div><div class="line"><span class="source c"><span class="meta preprocessor macro c"><span>#</span><span class="keyword control import define c"><span>define</span></span><span>&nbsp;</span><span class="entity name function preprocessor c"><span>TOC_MAX_FOO</span></span><span>&nbsp;&nbsp;</span><span class="constant numeric c"><span>20</span></span></span></span></div><div class="line"><span class="source c"><span>&nbsp;</span></span></div><div class="line"><span class="source c"><span class="comment line double-slash c++"><span class="punctuation definition comment c++"><span>//</span></span><span>&nbsp;a&nbsp;global&nbsp;variable&nbsp;exported&nbsp;by&nbsp;library</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source c"><span class="comment line double-slash c++"><span class="punctuation definition comment c++"><span>//</span></span><span>&nbsp;if&nbsp;you&nbsp;don&#39;t&nbsp;know&nbsp;what&nbsp;extern&nbsp;means&nbsp;you&nbsp;should&nbsp;probably&nbsp;look&nbsp;that&nbsp;up</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source c"><span class="comment line double-slash c++"><span class="punctuation definition comment c++"><span>//</span></span><span>&nbsp;..&nbsp;it&nbsp;helps&nbsp;to&nbsp;think&nbsp;that&nbsp;this&nbsp;file,&nbsp;when&nbsp;you&nbsp;#include&nbsp;it,&nbsp;will&nbsp;pretty&nbsp;much</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source c"><span class="comment line double-slash c++"><span class="punctuation definition comment c++"><span>//</span></span><span>&nbsp;be&nbsp;transcluded&nbsp;into&nbsp;your&nbsp;source&nbsp;file,&nbsp;after&nbsp;the&nbsp;c&nbsp;preprocessor&nbsp;runs</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source c"><span class="storage modifier c"><span>extern</span></span><span>&nbsp;</span><span class="storage type c"><span>int</span></span><span>&nbsp;toc_extern_export;</span></span></div><div class="line"><span class="source c"><span>&nbsp;</span></span></div><div class="line"><span class="source c"><span class="comment line double-slash c++"><span class="punctuation definition comment c++"><span>//</span></span><span>&nbsp;function&nbsp;prototypes&nbsp;for&nbsp;a&nbsp;function&nbsp;exported&nbsp;by&nbsp;library:</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source c"><span class="storage modifier c"><span>extern</span></span><span>&nbsp;</span><span class="storage type c"><span>long</span></span><span>&nbsp;</span><span class="storage type c"><span>int</span></span><span class="meta function c"><span class="punctuation whitespace function leading c"><span>&nbsp;</span></span><span class="entity name function c"><span>toc_maximum</span></span><span class="meta parens c"><span class="punctuation section parens begin c"><span>(</span></span><span class="storage type c"><span>long</span></span><span>&nbsp;</span><span class="storage type c"><span>int</span></span><span>&nbsp;x,&nbsp;</span><span class="storage type c"><span>long</span></span><span>&nbsp;</span><span class="storage type c"><span>int</span></span><span>&nbsp;y</span><span class="punctuation section parens end c"><span>)</span></span></span><span>;</span></span></span></div><div class="line"><span class="source c"><span class="storage modifier c"><span>extern</span></span><span>&nbsp;</span><span class="storage type c"><span>long</span></span><span>&nbsp;</span><span class="storage type c"><span>int</span></span><span class="meta function c"><span class="punctuation whitespace function leading c"><span>&nbsp;</span></span><span class="entity name function c"><span>toc_XX_unicode</span></span><span class="meta parens c"><span class="punctuation section parens begin c"><span>(</span></span><span class="storage type c"><span>long</span></span><span>&nbsp;</span><span class="storage type c"><span>int</span></span><span>&nbsp;x,&nbsp;</span><span class="storage type c"><span>long</span></span><span>&nbsp;</span><span class="storage type c"><span>int</span></span><span>&nbsp;y</span><span class="punctuation section parens end c"><span>)</span></span></span><span>;</span></span></span></div><div class="line"><span class="source c"><span>&nbsp;</span></span></div><div class="line"><span class="source c"><span class="meta preprocessor c"><span>#</span><span class="keyword control import c"><span>endif</span></span></span></span></div></pre>
<p>Also don&#39;t make fun of my C.</p>
<p>We&#39;ll use that header later, but for now, we can compile the above on OSX (or linux but this isn&#39;t an article on Elf dude) using:</p>
<p><code>clang -dynamiclib -o libtoc.dylib libtoc.c</code></p>
<p>or</p>
<p><code>clang -shared -o libtoc.dylib libtoc.c</code> or <code>gcc -shared -o libtoc.dylib libtoc.c</code></p>
<p>Not sure what the precise difference is between <code>-dynamiclib</code> and <code>-shared</code>; on my system, the binaries have the same size, but differ.</p>
<p>For fun, run <code>nm -a libtoc.dylib</code> and check the output, should be something like:</p>
<pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0000000000000f90&nbsp;S&nbsp;_kTOC_MAGICAL_FUN</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0000000000000f70&nbsp;T&nbsp;_toc_XX_unicode</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0000000000001000&nbsp;D&nbsp;_toc_extern_export</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0000000000000f30&nbsp;T&nbsp;_toc_maximum</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta paragraph text"><span>U&nbsp;dyld_stub_binder</span></span></span></div></pre><p>Now for even more fun, run <code>strip libtoc.dylib</code> and rerun <code>nm</code> again; it should complain that there isn&#39;t a name list... because there isn&#39;t, you stripped it.</p>
<p>Unfortunately, <code>nm</code> uses the nlist symbol table to generate its output, and after you strip it, it&#39;s pretty worthless on OSX (not so much on linux, with the right flags; unless of course you <code>sstrip</code> the binary, then you&#39;re in a sort of similar circumstance to what we&#39;re in now).</p>
<p>Fortunately, we can still statically determine the symbols that <code>libtoc</code> exports by getting the exports offset from the <code>dyld_info_command</code> struct field, and walking the export trie.</p>
<h4 id="export-trie">Export Trie</h4>
<p>Using <code>otool -l</code> and grepping through the output for <code>LC_DYLD_INFO_ONLY</code> to find the <code>export_off</code> value, I highly recommend opening up a hex editor (<code>M-x hexl-find-file</code> if you&#39;are cool), and jumping to that location in the binary.  Mine is 0x2000, yours will probably be different.</p>
<p>When you do, you&#39;ll see something like this:</p>
<pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>00002000:&nbsp;0001&nbsp;5f00&nbsp;0500&nbsp;0274&nbsp;6f63&nbsp;5f00&nbsp;1f6b&nbsp;544f&nbsp;&nbsp;.._....toc_..kTO</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>00002010:&nbsp;435f&nbsp;4d41&nbsp;4749&nbsp;4341&nbsp;4c5f&nbsp;4655&nbsp;4e00&nbsp;4f00&nbsp;&nbsp;C_MAGICAL_FUN.O.</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>00002020:&nbsp;036d&nbsp;6178&nbsp;696d&nbsp;756d&nbsp;0045&nbsp;5858&nbsp;5f75&nbsp;6e69&nbsp;&nbsp;.maximum.EXX_uni</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>00002030:&nbsp;636f&nbsp;6465&nbsp;004a&nbsp;6578&nbsp;7465&nbsp;726e&nbsp;5f65&nbsp;7870&nbsp;&nbsp;code.Jextern_exp</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>00002040:&nbsp;6f72&nbsp;7400&nbsp;5403&nbsp;00b0&nbsp;1e00&nbsp;0300&nbsp;f01e&nbsp;0003&nbsp;&nbsp;ort.T...........</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>00002050:&nbsp;0090&nbsp;1f00&nbsp;0300&nbsp;8020&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;&nbsp;.......&nbsp;........</span></span></span></div></pre><p>which is the entire export trie, since <code>export_size</code> indicates it is 96 bytes (0x60).</p>
<p>A mach export trie can be summarized as follows:</p>
<ol>
<li><p>Every node either has terminal string information, or not.  There is at most one (1) terminal string information at a mach trie node.</p>
<p>a. If the node does not have terminal information, then this is marked by a 0x00 byte.</p>
<p>b. If it does, then instead of 0x00, a uleb128 represents the <em>size</em> of the terminal string information at this node (not including the number of bytes used for the size uleb).  This is called &quot;optional exported information&quot;. <strong>Note:</strong> the dyld source code notes that the only time the export information size is greater than 127 is when the terminal type is a &quot;reexport with name&quot;. We&#39;ll get to this, but the byte 127 is very special for leb128 encodings.  Its binary representation is: 0111 1111; i.e., it&#39;s the maximum integer we can represent without using another Leb128 byte, because a clear 8th bit marks the end of the leb128 byte stream.</p>
</li>
<li><p>If the node has exported information, following the size is a byte for the export symbol flags. Exported symbols have both a <strong>kind</strong> and for lack of a better word, a <strong>type</strong>.  To get the kind, you need to bitmask the flag with 0x3 to get the &quot;kind&quot; (i.e., it&#39;s in the lower two bits of the bytes&#39; lower nibble), of which there are three possible cases (only 2 of which are documented in <code>loader.h</code>):</p>
<ul>
<li>a regular symbol (0x00);</li>
<li>a thread local symbol (0x01)</li>
<li>an absolute symbol (0x02) (&quot;documented&quot; in dyld source code as an #ifndef in <code>ImageLoaderMachOCompressed.cpp</code>, line 42)</li>
</ul>
<p>A symbol also has four types, starting from the upper two bits of the flag&#39;s lower nibble, which determine the information that follows:</p>
<ul>
<li>regular (type bits are empty, i.e., the flag is equal to the kind), with a uleb128 address following</li>
<li>weak (0x4), same as a regular symbol, except it&#39;s a weak definition, and dyld can return 0 if not found, and that&#39;s OK (I think)</li>
<li>a reexport (0x8), with a uleb128 library ordinal indexing into the library &quot;array&quot; where the real symbol is found, followed by an optional null terminated string designating the symbol&#39;s name in the library it&#39;s reexported from (this is when the exported information size can be greater than 127)</li>
<li>a stub (0x10), with a uleb128 stub offset followed by a uleb128 resolver offset</li>
</ul>
<p>Thread local symbols and absolute symbols <em><strong>cannot</strong></em> be a stub type, otherwise dyld throws an exception (line 662 in <code>ImageLoaderMachOCompressed.cpp</code>).</p>
<p>Most symbols are regular symbols, which give the offset in the binary to the symbol.</p>
<p>Reexports are less common.  If you&#39;re familiar with GNU IFUNCS, they&#39;re sort of similar.  For example, you&#39;ll find reexports in <code>/usr/lib/system/libsystem_c.dylib</code> for some famous symbols you may remember like: <code>_strcmp</code>, <code>_memcpy</code>, <code>_strcpy</code> and other routines, known for such things as: major security vulnerabilities throughout the years.  The reexport library ordinal typically points to platform versions of these routines in <code>/usr/lib/system/libsystem_platform.dylib</code>, with &quot;__platform&quot; prefixed to the symbol name.</p>
<p>Stubs are also less common (I think it&#39;s an Objective C Thing™; I don&#39;t see them in <code>libstdc++.dylib</code> or various Swift dylibs like <code>libswiftCore.dylib</code>). I don&#39;t really know what it means, but they&#39;re present in <code>/usr/lib/libobjc.dylib</code>, with <code>_objc_getProperty</code> being an example.</p>
<p>Weak symbols I&#39;ve typically only seen in <code>/usr/lib/libstdc++.dylib</code>, so I could be wrong about the interpretation, and it might be a C++ Thing™.</p>
</li>
<li><p>After a 0x00 node byte, or the optional exported information, is a <em>byte</em> (not a uleb128 according to documentation) indicating the number of branches leaving this node (offset to num branches byte = num bytes in size uleb128 + size of optional exported information). Hence, there can only be 255 branches from a single node.  This is fine for ascii, but <em>not</em> fine for unicode, cause, there&#39;s, like, a lot of those, man.  And yes, mach-o binaries support unicode symbols.  And yes, you should probably be nodding your head in deep appreciation for this scintillating piece of sweetness implemented by the OSX devs.</p>
</li>
<li><p>After the number of branches, follow the branches, one after the other.  A branch consists of a:</p>
<ol>
<li><p>A null-terminated string representing the prefix at that node in the trie, and</p>
</li>
<li><p>A uleb128 ostensibly representing the branches&#39; pointer to its child node, but in reality, an offset <strong><em>from the start of the trie</em></strong> to the next node</p>
</li>
</ol>
</li>
<li><p>And finally, as my favorite Professor-qua-logician liked to call it when recursively describing logical formulae, the &quot;woody woodpecker clause&quot;: that&#39;s all folks.</p>
</li>
</ol>
<p>That was a lot of text.  I love examples, so in the interest of generating more text, I&#39;ll walk the trie from <code>libtoc.dylib</code> using a program I wrote, and give some in depth analysis of the first few recursions.  Here is the output:</p>
<pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>export&nbsp;init:&nbsp;0x2000&nbsp;0x2060</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>@&nbsp;0x2000&nbsp;node:&nbsp;0x0&nbsp;current_symbol:</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta paragraph text"><span>BRAN&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>&nbsp;&nbsp;&nbsp;&nbsp;(0)&nbsp;string:&nbsp;_&nbsp;next_node:&nbsp;0x2005</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>@&nbsp;0x2005&nbsp;node:&nbsp;0x0&nbsp;current_symbol:&nbsp;_</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta paragraph text"><span>BRAN&nbsp;2</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>&nbsp;&nbsp;&nbsp;&nbsp;(0)&nbsp;string:&nbsp;_toc_&nbsp;next_node:&nbsp;0x201f</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>&nbsp;&nbsp;&nbsp;&nbsp;(1)&nbsp;string:&nbsp;_kTOC_MAGICAL_FUN&nbsp;next_node:&nbsp;0x204f</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>@&nbsp;0x204f&nbsp;node:&nbsp;0x3&nbsp;current_symbol:&nbsp;_kTOC_MAGICAL_FUN</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta paragraph text"><span>TERM&nbsp;0&nbsp;flags:&nbsp;0x0</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>&nbsp;&nbsp;&nbsp;&nbsp;0xf90&nbsp;_kTOC_MAGICAL_FUN&nbsp;E&nbsp;-&gt;&nbsp;libtoc.so&nbsp;&nbsp;</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>@&nbsp;0x201f&nbsp;node:&nbsp;0x0&nbsp;current_symbol:&nbsp;_toc_</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta paragraph text"><span>BRAN&nbsp;3</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>&nbsp;&nbsp;&nbsp;&nbsp;(0)&nbsp;string:&nbsp;_toc_maximum&nbsp;next_node:&nbsp;0x2045</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>&nbsp;&nbsp;&nbsp;&nbsp;(1)&nbsp;string:&nbsp;_toc_XX_unicode&nbsp;next_node:&nbsp;0x204a</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>&nbsp;&nbsp;&nbsp;&nbsp;(2)&nbsp;string:&nbsp;_toc_extern_export&nbsp;next_node:&nbsp;0x2054</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>@&nbsp;0x2054&nbsp;node:&nbsp;0x3&nbsp;current_symbol:&nbsp;_toc_extern_export</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta paragraph text"><span>TERM&nbsp;0&nbsp;flags:&nbsp;0x0</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>&nbsp;&nbsp;&nbsp;&nbsp;0x1000&nbsp;_toc_extern_export&nbsp;E&nbsp;-&gt;&nbsp;libtoc.so&nbsp;&nbsp;</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>@&nbsp;0x204a&nbsp;node:&nbsp;0x3&nbsp;current_symbol:&nbsp;_toc_XX_unicode</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta paragraph text"><span>TERM&nbsp;0&nbsp;flags:&nbsp;0x0</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>&nbsp;&nbsp;&nbsp;&nbsp;0xf70&nbsp;_toc_XX_unicode&nbsp;E&nbsp;-&gt;&nbsp;libtoc.so&nbsp;&nbsp;</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>@&nbsp;0x2045&nbsp;node:&nbsp;0x3&nbsp;current_symbol:&nbsp;_toc_maximum</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta paragraph text"><span>TERM&nbsp;0&nbsp;flags:&nbsp;0x0</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>&nbsp;&nbsp;&nbsp;&nbsp;0xf30&nbsp;_toc_maximum&nbsp;E&nbsp;-&gt;&nbsp;libtoc.so</span></span></span></div></pre><p>We start at the offset 0x2000 (given by <code>export_off</code> in the dyld info load command), and read a uleb128 for the node size, if any.  Our current symbol is the empty string.  So, we&#39;re right here:</p>
<pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>00002000:&nbsp;0001&nbsp;5f00&nbsp;0500&nbsp;0274&nbsp;6f63&nbsp;5f00&nbsp;1f6b&nbsp;544f&nbsp;&nbsp;.._....toc_..kTO</span></span></span></div></pre><p>So we read the first byte, 0x00, then 0x01 (1 branch), which is followed by the (one) branch composed of the byte sequence: 0x5f 0x00 0x05.  It has the symbol &quot;_&quot; (0x5f is ascii/UTF-8 for &quot;_&quot;), the null terminator, and the offset to its child node, which is 5 bytes from 0x2000, or 0x2005 (0x05 in uleb128 is 5; bytes greater than 0x7f are multi-byte uleb128 numbers).</p>
<p>Since the algorithm above is depth first, and depth first searches are the best (especially on the internet, as a colleague used to say), let&#39;s goto 0x2005.  At 0x2005 we see 0x00 again (count 5 bytes in from the above hex), which tells use the node has no optional information; the next uleb128 tells us that there are 0x02 (2) branches, the first of which has the symbol &quot;toc_&quot; (from the bytes 0x7f 0x6f 0x63 0x5f 0x00 in ascii/UTF-8), and points to its child node at 0x2000 + 0x1f, which is in the next line of the hex.</p>
<pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>00002010:&nbsp;435f&nbsp;4d41&nbsp;4749&nbsp;4341&nbsp;4c5f&nbsp;4655&nbsp;4e00&nbsp;4f00&nbsp;&nbsp;C_MAGICAL_FUN.O.</span></span></span></div></pre><p>We still need to finish the second branch though, which is just after the byte 0x1f and starts with 0x6b on the first line of hex; the branch has the symbol &quot;kTOC_MAGICAL_FUN&quot; (which bleeds into the second line of hex above) and points to 0x2000 + 0x4f.</p>
<p>The trie walk repeats in this manner until we run out of nodes (or reach the trie start offset + trie size, in which case something went wrong).  The only difference is when a node also has terminal export symbol information; we can see an example of this in the node at offset 0x2054, whose current symbol is &quot;kTOC_MAGICAL_FUN&quot; (which is built up in the course of searching):</p>
<pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>00002050:&nbsp;0090&nbsp;1f00&nbsp;0300&nbsp;8020&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;&nbsp;.......&nbsp;........</span></span></span></div></pre><p>4 bytes in from 0x2050 lands us at the byte 0x03.  This is a uleb128 designating the size (3) of the export information at this node.  The next byte (0x00) is our export symbol flags, which means it&#39;s a regular symbol; after that we&#39;re given the uleb128 (0x80 0x20) representing its offset.  This is a two byte uleb128 sequence since 0x80 is greater than 0x7f, and whose value for brevity&#39;s sake is 0xf90 --- in other words the offset to the symbol &quot;kTOC_MAGICAL_FUN&quot; in the dynamic library <code>libtoc.dylib</code> binary is 0xf90.</p>
<p>If you&#39;ve still got that hex editor running, jump to 0xf90 in <code>libtoc.dylib</code> and you should see <code>ef be ad de</code> --- dead beef, bro.  If you don&#39;t know why it appears like that I&#39;m pretty amazed you read this far, but you should probably stop. ಠ_ಠ</p>
<p>Lastly, and <strong>very importantly</strong>, the <em>next</em> uleb128 after whatever type the symbol is (so, depending on the type, it could be several bytes or uleb&#39;s later, see point 2. in the mach trie summary), is the number of child branches.  In the case of &quot;kTOC_MAGICAL_FUN&quot;, the number is 0.  But, it doesn&#39;t have to be.  The node with terminal export information can also have children; a good example of this can be found in <code>/usr/lib/system/libsystem_c.dylib</code> with <code>_printf</code> and <code>_printf_l</code>, where the latter will be a child node containing the export information for <code>_printf</code>; don&#39;t terminate your loop (or recursion if you&#39;re awesome) when you encounter a &quot;terminal&quot; node, as strange as that sounds, because it might have children.</p>
<h3 id="imports">Imports</h3>
<p>Imports on mach are stored in the same linkedit section as exports are.  As mentioned earlier, they are  &quot;encoded&quot; using a finite state automaton.  The FSA accepts so-called &quot;bind opcodes&quot;, which have immediate and uleb128/sleb128 arguments, which alter the current record.  When a &quot;bind&quot; bind opcode is encountered, it pushes the current import symbol information record onto a list or array, however you want to think about it.</p>
<p>Importantly, that same record, and all of its values, are modified by further bind commands; when a &quot;done&quot; opcode is encountered, the current record is pushed, and <em>then</em> the record is cleared, starting you off with all zero values again.</p>
<p>What this scheme accomplishes is a dense encoding of the import information in the binary; many times only the symbol name is changed, and then the record is bound (because dyld auto-increments the binary offset/pointer value on a bind).</p>
<p>It&#39;s also important to note that there are three bind &quot;sections&quot;:</p>
<ul>
<li>bind/non-lazy, (usually data variables, like exported ints)</li>
<li>weak (a C++ Thing™)</li>
<li>lazy (this will typically be exported functions from the library)</li>
</ul>
<p>The non-lazy imports are bound on program load; thus they&#39;re already present on the program&#39;s entry to main.  </p>
<p>Weak symbols are bound after the non-lazy symbols are bound:</p>
<blockquote>
<p>   Some C++ programs require dyld to unique symbols so that all
   images in the process use the same copy of some code/data.
   This step is done after binding. The content of the weak_bind
   info is an opcode stream like the bind_info.  But it is sorted
   alphabetically by symbol name.  This enable dyld to walk
   all images with weak binding information in order and look
   for collisions.  If there are no collisions, dyld does
   no updating.  That means that some fixups are also encoded
   in the bind_info.  For instance, all calls to &quot;operator new&quot;
   are first bound to libstdc++.dylib using the information
   in bind_info.  Then if some image overrides operator new
   that is detected when the weak_bind information is processed
   and the call to operator new is then rebound.</p>
</blockquote>
<p>The lazy symbols are bound at runtime.</p>
<p>I highly recommend reading the dyld source code if you want to understand dyld&#39;s import binding process.  There are particular details (like incrementing by a pointer size after each done call) that you can&#39;t really understand by staring at the structure, or reading the paltry <code>loader.h</code> comments.  <code>ImageLoaderMachOCompressed::eachBind</code> should send you on your way.</p>
<p>But if that isn&#39;t your cup of tea, you&#39;re in luck, because I&#39;ll do an in-depth writeup here. Since imports require a dynamic library to link against, and we just created and went over the exports of a simple dynamic library, we can use <code>libtoc.dylib</code>&#39;s header file in a simple C program to illustrate mach imports.</p>
<p>Here is a simple C program using <code>libtoc.dylib</code>&#39;s exported symbols:</p>
<pre class="editor-colors lang-c"><div class="line"><span class="source c"><span class="comment line double-slash c++"><span class="punctuation definition comment c++"><span>//</span></span><span>toc.c</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source c"><span>#include&lt;stdio.h&gt;</span></span></div><div class="line"><span class="source c"><span class="meta preprocessor c include"><span>#</span><span class="keyword control import include c"><span>include</span></span><span>&nbsp;</span><span class="string quoted double include c"><span class="punctuation definition string begin c"><span>&quot;</span></span><span>include/libtoc.h</span><span class="punctuation definition string end c"><span>&quot;</span></span></span></span></span></div><div class="line"><span class="source c"><span>&nbsp;</span></span></div><div class="line"><span class="source c"><span class="storage type c"><span>int</span></span><span class="meta function c"><span class="punctuation whitespace function leading c"><span>&nbsp;</span></span><span class="entity name function c"><span>main</span></span><span>&nbsp;</span><span class="meta parens c"><span class="punctuation section parens begin c"><span>(</span></span><span class="punctuation section parens end c"><span>)</span></span></span><span class="meta block c"><span class="punctuation section block begin c"><span>{</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;</span><span class="storage type c"><span>long</span></span><span>&nbsp;</span><span class="storage type c"><span>int</span></span><span>&nbsp;max&nbsp;=</span><span class="meta function-call c"><span class="punctuation whitespace function-call leading c"><span>&nbsp;</span></span><span class="support function any-method c"><span>toc_maximum</span></span><span>(</span></span><span class="constant numeric c"><span>2</span></span><span>,</span><span class="constant numeric c"><span>3</span></span><span>);</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="punctuation whitespace support function leading c"><span>&nbsp;&nbsp;</span></span><span class="support function C99 c"><span>printf</span></span><span>&nbsp;(</span><span class="string quoted double c"><span class="punctuation definition string begin c"><span>&quot;</span></span><span>kTOC_MAGICAL_FUN:&nbsp;0x</span><span class="constant other placeholder c"><span>%lx</span></span><span class="constant character escape c"><span>\n</span></span><span class="punctuation definition string end c"><span>&quot;</span></span></span><span>,&nbsp;</span><span class="constant other variable mac-classic c"><span>kTOC_MAGICAL_FUN</span></span><span>);</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="punctuation whitespace support function leading c"><span>&nbsp;&nbsp;</span></span><span class="support function C99 c"><span>printf</span></span><span>&nbsp;(</span><span class="string quoted double c"><span class="punctuation definition string begin c"><span>&quot;</span></span><span>toc_extern_export:&nbsp;0x</span><span class="constant other placeholder c"><span>%x</span></span><span class="constant character escape c"><span>\n</span></span><span class="punctuation definition string end c"><span>&quot;</span></span></span><span>,&nbsp;toc_extern_export);</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="punctuation whitespace support function leading c"><span>&nbsp;&nbsp;</span></span><span class="support function C99 c"><span>printf</span></span><span>&nbsp;(</span><span class="string quoted double c"><span class="punctuation definition string begin c"><span>&quot;</span></span><span>===FUNS===</span><span class="constant character escape c"><span>\n</span></span><span class="punctuation definition string end c"><span>&quot;</span></span></span><span>);</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="punctuation whitespace support function leading c"><span>&nbsp;&nbsp;</span></span><span class="support function C99 c"><span>printf</span></span><span>&nbsp;(</span><span class="string quoted double c"><span class="punctuation definition string begin c"><span>&quot;</span></span><span>toc_XX_unicode:&nbsp;0x</span><span class="constant other placeholder c"><span>%lu</span></span><span class="constant character escape c"><span>\n</span></span><span class="punctuation definition string end c"><span>&quot;</span></span></span><span>,</span><span class="meta function-call c"><span class="punctuation whitespace function-call leading c"><span>&nbsp;</span></span><span class="support function any-method c"><span>toc_XX_unicode</span></span><span>(</span></span><span class="constant numeric c"><span>3</span></span><span>,&nbsp;</span><span class="constant numeric c"><span>5</span></span><span>));</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="punctuation whitespace support function leading c"><span>&nbsp;&nbsp;</span></span><span class="support function C99 c"><span>printf</span></span><span>(</span><span class="string quoted double c"><span class="punctuation definition string begin c"><span>&quot;</span></span><span>toc_maximum:&nbsp;</span><span class="constant other placeholder c"><span>%lu</span></span><span class="constant character escape c"><span>\n</span></span><span class="punctuation definition string end c"><span>&quot;</span></span></span><span>,&nbsp;max);</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;</span><span class="keyword control c"><span>return</span></span><span>&nbsp;</span><span class="constant numeric c"><span>0</span></span><span>;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="punctuation section block end c"><span>}</span></span></span></span></span></div></pre>
<p>To get this working right, without installing random libs into your <code>/usr/lib</code>, I&#39;m going to assume you&#39;re in some folder called <code>toc</code> (where <code>toc</code> resides doesn&#39;t matter; put it in <code>~</code> or <code>/tmp/</code> for all I care).  In addition, you should have the following files and directories <em>exactly</em> as follows:  <code>toc/include/libtoc.h</code> and <code>toc/lib/libtoc.dylib</code> and <code>toc/toc.c</code>.  </p>
<p>Now, we need to recompile the dynamic lib (or use <code>install_name_tool</code>, but if you know how to do that, you can compile <code>toc.c</code> as normal and then run it on the compiled binary to use <code>libtoc.dylib</code> without recompilation).</p>
<p>There are a number of ways to do this, but this should work:</p>
<p><code>gcc -dynamiclib -install_name @executable_path/lib/libtoc.dylib lib/libtoc.c -o lib/libtoc.dylib</code></p>
<p>What this did was generate a dynamic library named <code>libtoc.dylib</code> with an install name (<code>LC_DYLD_ID</code>) of &quot;@executable<em>path/lib/libtoc.dylib&quot;.  What _this</em> does is basically require any binary linking against this newly recompiled <code>libtoc.dylib</code> to be <strong>executed</strong> in a folder which contains a folder named <code>lib</code>, which contains <code>libtoc.dylib</code> --- which if you setup your directory structure above, is the case.  It&#39;s weird, but whatever.</p>
<p>You should be able to compile <code>toc.c</code> now with something like:</p>
<p><code>gcc -o toc -Llib -ltoc  toc.c</code></p>
<p>And <em>now</em>, you should be able to execute <code>toc</code>, which prints:</p>
<pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>kTOC_MAGICAL_FUN:&nbsp;0xdeadbeef</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>toc_extern_export:&nbsp;0xb1b1eb0b</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>===FUNS===</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>toc_XX_unicode:&nbsp;0x60</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>toc_maximum:&nbsp;3</span></span></span></div></pre><p>If not, either my directions are wrong, or you didn&#39;t follow my directions (exclusive or).</p>
<h4 id="mach-import-bind-fsa">Mach Import Bind FSA</h4>
<p>Now that we&#39;ve got a running mach-o binary with imports, we can run something like <code>otool -l | grep bind_</code> to get the import binding offsets.  My own program&#39;s output tells me:</p>
<pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>(&nbsp;4):&nbsp;DYLD_INFO_ONLY&nbsp;(0x80000022)&nbsp;48</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta paragraph text"><span>rebase_off:&nbsp;0x2000&nbsp;rebase_size:&nbsp;8</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta paragraph text"><span>bind_off:&nbsp;0x2008&nbsp;bind_size:&nbsp;80</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta paragraph text"><span>weak_bind_off:&nbsp;0x0&nbsp;weak_bind_size:&nbsp;0</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lazy_bind_off:&nbsp;0x2058&nbsp;lazy_bind_size:&nbsp;56</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;export_off:&nbsp;0x2090&nbsp;export_size:&nbsp;48</span></span></span></div></pre><p>Which says that the there aren&#39;t any weak bindings (only relevant for C++) and that the regular, non-lazy bindings start at offset 0x2008 and the lazy bindings (typically functions) start at 0x2058.</p>
<p>Open your favorite hex editor again and jump to your <code>bind_off</code> (as I said, mine is 0x2008, yours will probably be different).  You should see something like:</p>
<pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>00002000:&nbsp;1122&nbsp;2053&nbsp;0000&nbsp;0000&nbsp;1140&nbsp;5f6b&nbsp;544f&nbsp;435f&nbsp;&nbsp;.&quot;&nbsp;S.....@_kTOC_</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>00002010:&nbsp;4d41&nbsp;4749&nbsp;4341&nbsp;4c5f&nbsp;4655&nbsp;4e00&nbsp;5172&nbsp;1090&nbsp;&nbsp;MAGICAL_FUN.Qr..</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>00002020:&nbsp;405f&nbsp;746f&nbsp;635f&nbsp;6578&nbsp;7465&nbsp;726e&nbsp;5f65&nbsp;7870&nbsp;&nbsp;@_toc_extern_exp</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>00002030:&nbsp;6f72&nbsp;7400&nbsp;9012&nbsp;4064&nbsp;796c&nbsp;645f&nbsp;7374&nbsp;7562&nbsp;&nbsp;ort...@dyld_stub</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>00002040:&nbsp;5f62&nbsp;696e&nbsp;6465&nbsp;7200&nbsp;80e0&nbsp;ffff&nbsp;ffff&nbsp;ffff&nbsp;&nbsp;_binder.........</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>00002050:&nbsp;ffff&nbsp;0190&nbsp;0000&nbsp;0000&nbsp;7220&nbsp;1140&nbsp;5f74&nbsp;6f63&nbsp;&nbsp;........r&nbsp;.@_toc</span></span></span></div></pre><p><strong>Note</strong>: we start at 0x2008, and end at 0x2008 + 0x4f (because our size is 0x50, which is 80 in decimal), which means we start at that 0x11 byte, and end just before the 0x72 byte.</p>
<p>The FSA always starts (or is initialized with) with a blank record, which looks something like:</p>
<pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>seg_index:&nbsp;0&nbsp;seg_offset:&nbsp;0x0&nbsp;lib_ordinal:&nbsp;0&nbsp;type:&nbsp;0&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div></pre><p>The special dylib isn&#39;t actually a field, but it&#39;s useful consider it as one.  You see this value set by the BIND_OPCODE_SET_DYLIB_SPECIAL_IMM opcode, which says the import comes from itself, from the main executable, or is a flat lookup symbol (like linux).</p>
<p>When the FSA starts its loop (or recurses), it always eats a single byte, which it then bitmasks with 0xF0 to get the bind &quot;opcode&quot;.  All of the valid (import) bind opcodes are as follows:</p>
<pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x00&nbsp;-&gt;&nbsp;&nbsp;BIND_OPCODE_DONE</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x10&nbsp;-&gt;&nbsp;&nbsp;BIND_OPCODE_SET_DYLIB_ORDINAL_IMM</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x20&nbsp;-&gt;&nbsp;&nbsp;BIND_OPCODE_SET_DYLIB_ORDINAL_ULEB</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x30&nbsp;-&gt;&nbsp;&nbsp;BIND_OPCODE_SET_DYLIB_SPECIAL_IMM</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x40&nbsp;-&gt;&nbsp;&nbsp;BIND_OPCODE_SET_SYMBOL_TRAILING_FLAGS_IMM</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x50&nbsp;-&gt;&nbsp;&nbsp;BIND_OPCODE_SET_TYPE_IMM</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x60&nbsp;-&gt;&nbsp;&nbsp;BIND_OPCODE_SET_ADDEND_SLEB</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x70&nbsp;-&gt;&nbsp;&nbsp;BIND_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x80&nbsp;-&gt;&nbsp;&nbsp;BIND_OPCODE_ADD_ADDR_ULEB</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x90&nbsp;-&gt;&nbsp;&nbsp;BIND_OPCODE_DO_BIND</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0xa0&nbsp;-&gt;&nbsp;&nbsp;BIND_OPCODE_DO_BIND_ADD_ADDR_ULEB</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0xb0&nbsp;-&gt;&nbsp;&nbsp;BIND_OPCODE_DO_BIND_ADD_ADDR_IMM_SCALED</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0xc0&nbsp;-&gt;&nbsp;&nbsp;BIND_OPCODE_DO_BIND_ULEB_TIMES_SKIPPING_ULEB</span></span></span></div></pre><p>Our FSA starts on this line of hex, at offset 0x8:</p>
<pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>00002000:&nbsp;1122&nbsp;2053&nbsp;0000&nbsp;0000&nbsp;1140&nbsp;5f6b&nbsp;544f&nbsp;435f&nbsp;&nbsp;.&quot;&nbsp;S.....@_kTOC_</span></span></span></div></pre><p>So in our case, we&#39;re looking at <code>BIND_OPCODE_SET_DYLIB_ORDINAL_IMM</code> (0x11 &amp; 0xF0 == 0x10), which means to set the library ordinal field to the value in the immediate argument place.</p>
<p>All immediate arguments are obtained by bitmasking the byte with, you guessed it, 0x0F.  In this case, the library indexed by 1, which is our <code>libtoc.dylib</code> (or rather <code>@executable_path/lib/libtoc.dylib</code>).</p>
<p>The dylib ordinal imm opcode is a single byte in length, so we eat another byte (0x40) and examine its opcode: BIND_OPCODE_SET_SYMBOL_TRAILING_FLAGS_IMM.</p>
<p>Our immediate is 0x0, which tells us to set the flags to 0x0 (which means it is neither a weak import 0x1 or a weak definition 0x8).  Now, for this opcode, what follows is the symbol name, which is a null-terminated UTF-8 string.</p>
<p>This takes us into the second line of hex:</p>
<pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>00002010:&nbsp;4d41&nbsp;4749&nbsp;4341&nbsp;4c5f&nbsp;4655&nbsp;4e00&nbsp;5172&nbsp;1090&nbsp;&nbsp;MAGICAL_FUN.Qr..</span></span></span></div></pre><p>At the 11th byte, we hit our null terminator, which yields the symbol name &quot;kTOC_MAGICAL_FUN&quot;.  We are now free to eat another opcode byte, which is 0x51.</p>
<p>Our table tells us that this is BIND_OPCODE_SET_TYPE_IMM, which sets the type of the import to 0x1.</p>
<p>The types of an import are:</p>
<ul>
<li>BIND_TYPE_POINTER (1)</li>
<li>BIND_TYPE_TEXT_ABSOLUTE32 (2)</li>
<li>BIND_TYPE_TEXT_PCREL32 (3)</li>
</ul>
<p>You&#39;ll almost always see pointer.</p>
<p>We now eat another opcode byte, this time 0x72: BIND_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB.  This opcode tells us to set the segment index to the immediate value (2), and its segment offset value to the uleb128 that follows, in this case: 0x10.</p>
<p>This means that after dyld runs, it will set the value of this symbol (*symbol) to what the pointer at offset 0x10 in segment 2 in the binary is pointing to.  In other words, if you <code>lldb toc</code> and set a breakpoint on main, then examine this address, you&#39;ll find more 0xdeadbeef.</p>
<p>In any event, eating the offset uleb128 puts us exactly at the byte 0x90, which is the opcode for BIND_OPCODE_DO_BIND.</p>
<p>Now, this is <strong>extremely important</strong> if you&#39;re writing your own implementation: the record up to this point is now <em>committed</em> (in dyld&#39;s case, it sends it off to a handler), and <strong><em>then</em></strong> the seg_offset is incremented by the size of a platform pointer (so 32 or 64 bits), and the bind FSA recurses with the record intact (or loops depending on your implementation).</p>
<p>You can see it in this switch case in dyld&#39;s source code (also note the <em>sweet</em> typo in &quot;symboFlags&quot;):</p>
<pre class="editor-colors lang-c"><div class="line"><span class="source c"><span class="keyword control c"><span>case</span></span><span>&nbsp;BIND_OPCODE_DO_BIND:</span></span></div><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>if</span></span><span>&nbsp;(&nbsp;address&nbsp;&gt;=&nbsp;segmentEndAddress&nbsp;)</span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="punctuation whitespace function leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="entity name function c"><span>throwBadBindingAddress</span></span><span class="meta parens c"><span class="punctuation section parens begin c"><span>(</span></span><span>address,&nbsp;segmentEndAddress,&nbsp;segmentIndex,&nbsp;start,&nbsp;end,&nbsp;p</span><span class="punctuation section parens end c"><span>)</span></span></span><span>;</span></span></span></div><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(this-&gt;*handler)(context,&nbsp;address,&nbsp;type,&nbsp;symbolName,&nbsp;symboFlags,&nbsp;addend,&nbsp;libraryOrdinal,&nbsp;</span><span class="string quoted double c"><span class="punctuation definition string begin c"><span>&quot;</span></span><span class="punctuation definition string end c"><span>&quot;</span></span></span><span>,&nbsp;&amp;last,&nbsp;</span><span class="constant language c"><span>false</span></span><span>);</span></span></div><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;address&nbsp;+=&nbsp;</span><span class="keyword operator sizeof c"><span>sizeof</span></span><span>(</span><span class="support type stdint c"><span>intptr_t</span></span><span>);</span></span></div><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>break</span></span><span>;</span></span></div></pre>
<p>And that&#39;s pretty much it; the FSA marches on until it reaches the end of the bind import information.</p>
<p>It&#39;s also important to note that the BIND_OPCODE_DONE opcode doesn&#39;t actually say &quot;stop reading import symbol information&quot;; rather it resets the import symbol information back to their zero values.</p>
<p>As for the meanings and structure of the other opcodes, they&#39;re pretty straightforward, except perhaps the scaling opcodes.  Usually all the hints you need are in the opcode names.  Just read the dyld source code if any of them confuse you.</p>
<p>Lastly, I&#39;ve attached the output of my bind opcode program running on the <code>toc</code> binary:</p>
<pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_SET_DYLIB_ORDINAL_IMM&nbsp;-&gt;&nbsp;0x11</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x0&nbsp;with&nbsp;&nbsp;seg_index:&nbsp;0&nbsp;seg_offset:&nbsp;0x0&nbsp;lib_ordinal:&nbsp;0&nbsp;type:&nbsp;0&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_SET_SYMBOL_TRAILING_FLAGS_IMM&nbsp;-&gt;&nbsp;0x40</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x1&nbsp;with&nbsp;&nbsp;seg_index:&nbsp;0&nbsp;seg_offset:&nbsp;0x0&nbsp;lib_ordinal:&nbsp;1&nbsp;type:&nbsp;0&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_SET_TYPE_IMM&nbsp;-&gt;&nbsp;0x51</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x14&nbsp;with&nbsp;_kTOC_MAGICAL_FUN&nbsp;seg_index:&nbsp;0&nbsp;seg_offset:&nbsp;0x0&nbsp;lib_ordinal:&nbsp;1&nbsp;type:&nbsp;0&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB&nbsp;-&gt;&nbsp;0x72</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x15&nbsp;with&nbsp;_kTOC_MAGICAL_FUN&nbsp;seg_index:&nbsp;0&nbsp;seg_offset:&nbsp;0x0&nbsp;lib_ordinal:&nbsp;1&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_DO_BIND&nbsp;-&gt;&nbsp;0x90</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x17&nbsp;with&nbsp;_kTOC_MAGICAL_FUN&nbsp;seg_index:&nbsp;2&nbsp;seg_offset:&nbsp;0x10&nbsp;lib_ordinal:&nbsp;1&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_SET_SYMBOL_TRAILING_FLAGS_IMM&nbsp;-&gt;&nbsp;0x40</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x18&nbsp;with&nbsp;_kTOC_MAGICAL_FUN&nbsp;seg_index:&nbsp;2&nbsp;seg_offset:&nbsp;0x18&nbsp;lib_ordinal:&nbsp;1&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_DO_BIND&nbsp;-&gt;&nbsp;0x90</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x2c&nbsp;with&nbsp;_toc_extern_export&nbsp;seg_index:&nbsp;2&nbsp;seg_offset:&nbsp;0x18&nbsp;lib_ordinal:&nbsp;1&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_SET_DYLIB_ORDINAL_IMM&nbsp;-&gt;&nbsp;0x12</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x2d&nbsp;with&nbsp;_toc_extern_export&nbsp;seg_index:&nbsp;2&nbsp;seg_offset:&nbsp;0x20&nbsp;lib_ordinal:&nbsp;1&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_SET_SYMBOL_TRAILING_FLAGS_IMM&nbsp;-&gt;&nbsp;0x40</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x2e&nbsp;with&nbsp;_toc_extern_export&nbsp;seg_index:&nbsp;2&nbsp;seg_offset:&nbsp;0x20&nbsp;lib_ordinal:&nbsp;2&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_ADD_ADDR_ULEB&nbsp;-&gt;&nbsp;0x80</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x40&nbsp;with&nbsp;dyld_stub_binder&nbsp;seg_index:&nbsp;2&nbsp;seg_offset:&nbsp;0x20&nbsp;lib_ordinal:&nbsp;2&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_DO_BIND&nbsp;-&gt;&nbsp;0x90</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x4b&nbsp;with&nbsp;dyld_stub_binder&nbsp;seg_index:&nbsp;2&nbsp;seg_offset:&nbsp;0x0&nbsp;lib_ordinal:&nbsp;2&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_DONE&nbsp;-&gt;&nbsp;0x0</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x4c&nbsp;with&nbsp;dyld_stub_binder&nbsp;seg_index:&nbsp;2&nbsp;seg_offset:&nbsp;0x8&nbsp;lib_ordinal:&nbsp;2&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_DONE&nbsp;-&gt;&nbsp;0x0</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x4d&nbsp;with&nbsp;&nbsp;seg_index:&nbsp;0&nbsp;seg_offset:&nbsp;0x0&nbsp;lib_ordinal:&nbsp;0&nbsp;type:&nbsp;0&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_DONE&nbsp;-&gt;&nbsp;0x0</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x4e&nbsp;with&nbsp;&nbsp;seg_index:&nbsp;0&nbsp;seg_offset:&nbsp;0x0&nbsp;lib_ordinal:&nbsp;0&nbsp;type:&nbsp;0&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_DONE&nbsp;-&gt;&nbsp;0x0</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x4f&nbsp;with&nbsp;&nbsp;seg_index:&nbsp;0&nbsp;seg_offset:&nbsp;0x0&nbsp;lib_ordinal:&nbsp;0&nbsp;type:&nbsp;0&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>End&nbsp;of&nbsp;opcode&nbsp;stream</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB&nbsp;-&gt;&nbsp;0x72</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x0&nbsp;with&nbsp;&nbsp;seg_index:&nbsp;0&nbsp;seg_offset:&nbsp;0x0&nbsp;lib_ordinal:&nbsp;0&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_SET_DYLIB_ORDINAL_IMM&nbsp;-&gt;&nbsp;0x11</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x2&nbsp;with&nbsp;&nbsp;seg_index:&nbsp;2&nbsp;seg_offset:&nbsp;0x20&nbsp;lib_ordinal:&nbsp;0&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_SET_SYMBOL_TRAILING_FLAGS_IMM&nbsp;-&gt;&nbsp;0x40</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x3&nbsp;with&nbsp;&nbsp;seg_index:&nbsp;2&nbsp;seg_offset:&nbsp;0x20&nbsp;lib_ordinal:&nbsp;1&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_DO_BIND&nbsp;-&gt;&nbsp;0x90</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x14&nbsp;with&nbsp;_toc_XX_unicode&nbsp;seg_index:&nbsp;2&nbsp;seg_offset:&nbsp;0x20&nbsp;lib_ordinal:&nbsp;1&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_DONE&nbsp;-&gt;&nbsp;0x0</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x15&nbsp;with&nbsp;_toc_XX_unicode&nbsp;seg_index:&nbsp;2&nbsp;seg_offset:&nbsp;0x28&nbsp;lib_ordinal:&nbsp;1&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB&nbsp;-&gt;&nbsp;0x72</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x16&nbsp;with&nbsp;&nbsp;seg_index:&nbsp;0&nbsp;seg_offset:&nbsp;0x0&nbsp;lib_ordinal:&nbsp;0&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_SET_DYLIB_ORDINAL_IMM&nbsp;-&gt;&nbsp;0x11</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x18&nbsp;with&nbsp;&nbsp;seg_index:&nbsp;2&nbsp;seg_offset:&nbsp;0x28&nbsp;lib_ordinal:&nbsp;0&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_SET_SYMBOL_TRAILING_FLAGS_IMM&nbsp;-&gt;&nbsp;0x40</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x19&nbsp;with&nbsp;&nbsp;seg_index:&nbsp;2&nbsp;seg_offset:&nbsp;0x28&nbsp;lib_ordinal:&nbsp;1&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_DO_BIND&nbsp;-&gt;&nbsp;0x90</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x27&nbsp;with&nbsp;_toc_maximum&nbsp;seg_index:&nbsp;2&nbsp;seg_offset:&nbsp;0x28&nbsp;lib_ordinal:&nbsp;1&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_DONE&nbsp;-&gt;&nbsp;0x0</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x28&nbsp;with&nbsp;_toc_maximum&nbsp;seg_index:&nbsp;2&nbsp;seg_offset:&nbsp;0x30&nbsp;lib_ordinal:&nbsp;1&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB&nbsp;-&gt;&nbsp;0x72</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x29&nbsp;with&nbsp;&nbsp;seg_index:&nbsp;0&nbsp;seg_offset:&nbsp;0x0&nbsp;lib_ordinal:&nbsp;0&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_SET_DYLIB_ORDINAL_IMM&nbsp;-&gt;&nbsp;0x12</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x2b&nbsp;with&nbsp;&nbsp;seg_index:&nbsp;2&nbsp;seg_offset:&nbsp;0x30&nbsp;lib_ordinal:&nbsp;0&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_SET_SYMBOL_TRAILING_FLAGS_IMM&nbsp;-&gt;&nbsp;0x40</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x2c&nbsp;with&nbsp;&nbsp;seg_index:&nbsp;2&nbsp;seg_offset:&nbsp;0x30&nbsp;lib_ordinal:&nbsp;2&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_DO_BIND&nbsp;-&gt;&nbsp;0x90</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x35&nbsp;with&nbsp;_printf&nbsp;seg_index:&nbsp;2&nbsp;seg_offset:&nbsp;0x30&nbsp;lib_ordinal:&nbsp;2&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_DONE&nbsp;-&gt;&nbsp;0x0</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x36&nbsp;with&nbsp;_printf&nbsp;seg_index:&nbsp;2&nbsp;seg_offset:&nbsp;0x38&nbsp;lib_ordinal:&nbsp;2&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span>&nbsp;</span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>BIND_OPCODE_DONE&nbsp;-&gt;&nbsp;0x0</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>0x37&nbsp;with&nbsp;&nbsp;seg_index:&nbsp;0&nbsp;seg_offset:&nbsp;0x0&nbsp;lib_ordinal:&nbsp;0&nbsp;type:&nbsp;1&nbsp;flags:&nbsp;0&nbsp;special_dylib:&nbsp;1</span></span></span></div><div class="line"><span class="text plain"><span class="meta paragraph text"><span>End&nbsp;of&nbsp;opcode&nbsp;stream</span></span></span></div></pre><h2 id="coda">Coda</h2>
<p>There&#39;s a lot more to talk about; rebase opcodes, estimating routine sizes, dependency graphs, unicode symbols, etc., etc.</p>
<p>The graph that adorns the beginning of this article is generated from my program, which computes the dynamic library interdependencies in <code>/usr/lib/*</code> (really any directory I specify).  I plan to open source the software at some point soon; hopefully after elf binary analysis is properly integrated.</p>
<p>The software tool is completely written in OCaml, and many thanks to the researchers at INRIA and the small, but dedicated community surrounding the language.</p>
<p>But I&#39;ll just end the article with another graph my tool generates, this time of the much linked-against <code>libz.dylib</code>, in all its logical splendor:</p>
    <p><img src="libz.dylib.png" alt="libz"></p></body>
  
</html>
